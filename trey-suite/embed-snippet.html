<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trey Panel</title>
  <style>
    html,body{margin:0;padding:0;font-family:ui-sans-serif,system-ui;-webkit-font-smoothing:antialiased}
    .wrap{display:flex;flex-direction:column;height:70vh;background:#fff}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #eee;gap:10px}
    .id{display:flex;align-items:center;gap:10px;min-width:0}
    .id img{width:28px;height:28px;border-radius:50%;object-fit:cover;border:1px solid #e5e5e5;flex:0 0 auto}
    .id h2{margin:0;font-size:16px;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;max-width:52vw}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    header button{border:0;background:#111;color:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
    main{flex:1;overflow:auto;padding:12px 14px}
    .muted{color:#666;font-size:13px}
    textarea{width:100%;min-height:90px;border:1px solid #ddd;border-radius:10px;padding:10px;font:inherit}
    .btn{border:0;background:#111;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="id">
        <img id="avatar" src="assets/trey.svg" alt="">
        <h2 id="hdr">Trey Assistant</h2>
      </div>
      <div class="row">
        <button id="btnImport">Import Profile</button>
        <button id="btnLoadTJF">Load TJF</button>
        <button id="btnReset">Reset Profile</button>
        <button id="btnProfile">Profile Card</button>
        <button onclick="parent.document.getElementById('bffPanel').style.display='none'">Close</button>
      </div>
    </header>

    <main>
      <div class="muted" id="status">Ready.</div>
      <p>Type a note, then click <b>Save</b> (demo only).</p>
      <textarea id="note" placeholder="Write something…"></textarea>
      <div style="margin-top:10px">
        <button class="btn" onclick="save()">Save</button>
        <button class="btn" onclick="alert('Coming soon ✨')">Ask Trey</button>
      </div>
    </main>
  </div>

  <script>
    const status = (m) => { const el = document.getElementById("status"); if (el) el.textContent = m; };

    // Safer parser: try JSON first; if it fails, strip BOM + trailing commas only (no // comment stripping).
    function parseProfileLoose(text){
      if (!text) return null;
      try { return JSON.parse(text); } catch {}
      try {
        let s = text.replace(/^\uFEFF/, "");        // strip BOM
        s = s.replace(/,\s*([}\]])/g, "$1");       // remove trailing commas
        return JSON.parse(s);
      } catch (e) { console.warn("Profile parse error:", e); return null; }
    }

    function applyProfile(obj){
      const p = obj?.personas?.[0] || {};
      const hdr  = document.getElementById("hdr");
      const av   = document.getElementById("avatar");
      if (hdr) hdr.textContent = `Trey Assistant — ${p.name || "Profile"}`;
      if (av && p.avatar) av.src = p.avatar;
      status("Profile loaded ✅");
    }

    function setProfileText(text){
      localStorage.setItem("bff_profile_json", text || "");
      const j = parseProfileLoose(text);
      if (j) applyProfile(j); else status("Profile stored (raw JSON).");
    }

    async function importProfileFromFile(){
      const inp = document.createElement("input");
      inp.type = "file"; inp.accept = "application/json";
      inp.onchange = async () => {
        const f = inp.files?.[0]; if (!f) return;
        const text = await f.text();
        setProfileText(text);
      };
      inp.click();
    }

    async function importProfileFromAssets(){
      const candidates = [
        "/bff-suite/assets/TJF_BFF_Profile.json", // absolute (site root on Pages)
        "assets/TJF_BFF_Profile.json"             // relative to this page
      ];
      for (const url of candidates) {
        try {
          const r = await fetch(url, { cache: "no-store" });
          if (r.ok) { const text = await r.text(); setProfileText(text); status("Loaded from " + url); return; }
        } catch {}
      }
      status("Could not load assets/TJF_BFF_Profile.json");
      alert("Make sure TJF_BFF_Profile.json is in trey-suite/assets/ and deployed.");
    }

    function resetProfile(){
      localStorage.removeItem("bff_profile_json");
      document.getElementById("hdr").textContent = "Trey Assistant";
      document.getElementById("avatar").src = "assets/trey.svg";
      status("Profile reset. Click Load TJF again.");
    }

    function save(){
      const txt = document.getElementById('note').value.trim();
      if(!txt){ alert('Type a note first.'); return; }
      const k = 'trey_notes';
      const all = JSON.parse(localStorage.getItem(k) || '[]');
      all.push({ t: Date.now(), text: txt });
      localStorage.setItem(k, JSON.stringify(all));
      document.getElementById('note').value = '';
      alert('Saved locally ✅');
    }

    document.getElementById('btnImport').onclick  = importProfileFromFile;
    document.getElementById('btnLoadTJF').onclick = importProfileFromAssets;
    document.getElementById('btnReset').onclick   = resetProfile;
    document.getElementById('btnProfile').onclick = () => window.open('TJF_Avatar_Profile_Card.html','_blank');

    (function boot(){
      const text = localStorage.getItem("bff_profile_json");
      const j = parseProfileLoose(text);
      if (j) applyProfile(j); else if (text) status("Profile stored (raw JSON).");
    })();
  </script>
<style>.ai-badge{margin-left:8px;background:#111;color:#fff;border-radius:9999px;padding:2px 8px;font-size:11px}</style>
<script>
(function(){
  function parseLoose(t){
    if(!t) return null;
    try{ return JSON.parse(t); }catch(e){}
    try{ t=t.replace(/^\\uFEFF/,"").replace(/,\\s*([}\\]])/g,"$1"); return JSON.parse(t); }catch(e){ return null; }
  }
  function ensureBadge(){
    let b=document.getElementById('aiBadge');
    if(!b){
      b=document.createElement('span'); b.id='aiBadge'; b.className='ai-badge';
      const head=document.querySelector('header .id'); if(head) head.appendChild(b);
    }
    return b;
  }
  function looksAI(avatar, p){
    const a=(avatar||'').toLowerCase();
    return !!(p?.synthetic_media || /(^|[_-])ai\\./.test(a));
  }
  function update(){
    const j = parseLoose(localStorage.getItem('bff_profile_json'));
    const p = j?.personas?.[0] || null;
    const isAI = p ? looksAI(p.avatar, p) : looksAI((document.getElementById('avatar')||{}).src, null);
    const b=ensureBadge();
    b.textContent = isAI ? 'AI-generated' : '';
    b.style.display = isAI ? 'inline-block' : 'none';
    const av=document.getElementById('avatar'); if(av && isAI) av.alt='AI-generated portrait';
  }
  const _apply = window.applyProfile;
  window.applyProfile = function(o){ if(typeof _apply==='function') _apply(o); try{ update(); }catch(e){} };
  document.addEventListener('DOMContentLoaded', update);
})();
</script>
</body>
</html>


