<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trey Panel</title>
  <style>
    html,body{margin:0;padding:0;font-family:ui-sans-serif,system-ui;-webkit-font-smoothing:antialiased}
    .wrap{display:flex;flex-direction:column;height:70vh;background:#fff}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #eee;gap:10px}
    .id{display:flex;align-items:center;gap:10px;min-width:0}
    .id img{width:28px;height:28px;border-radius:50%;object-fit:cover;border:1px solid #e5e5e5;flex:0 0 auto}
    .id h2{margin:0;font-size:16px;white-space:nowrap;text-overflow:ellipsis;overflow:hidden}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    header button{border:0;background:#111;color:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
    main{flex:1;overflow:auto;padding:12px 14px}
    .muted{color:#666;font-size:13px}
    textarea{width:100%;min-height:90px;border:1px solid #ddd;border-radius:10px;padding:10px;font:inherit}
    .btn{border:0;background:#111;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="id">
        <img id="avatar" src="assets/trey.svg" alt="">
        <h2 id="hdr">Trey Assistant</h2>
      </div>
      <div class="row">
        <button id="btnImport">Import Profile</button>
        <button id="btnLoadTJF">Load TJF</button>
        <button id="btnProfile">Profile Card</button>
        <button onclick="parent.document.getElementById('bffPanel').style.display='none'">Close</button>
      </div>
    </header>

    <main>
      <div class="muted" id="status">Ready.</div>
      <p>Type a note, then click <b>Save</b> (demo only).</p>
      <textarea id="note" placeholder="Write something…"></textarea>
      <div style="margin-top:10px">
        <button class="btn" onclick="save()">Save</button>
        <button class="btn" onclick="alert('Coming soon ✨')">Ask Trey</button>
      </div>
    </main>
  </div>

  <script>
    // --- Profile helpers (stored locally) ---
    function applyProfile(obj){
      try{
        const p = obj?.personas?.[0] || {};
        const name = p.name || "Profile";
        const hdr = document.getElementById("hdr");
        const av  = document.getElementById("avatar");
        if (hdr) hdr.textContent = `Trey Assistant — ${name}`;
        if (av && p.avatar) av.src = p.avatar;
        status("Profile loaded ✅");
      }catch{ status("Profile stored."); }
    }

    function setProfileText(text){
      localStorage.setItem("bff_profile_json", text);
      try { applyProfile(JSON.parse(text)); } catch { status("Profile stored (raw JSON)."); }
    }

    function status(msg){ document.getElementById("status").textContent = msg; }

    async function importProfileFromFile(){
      const inp = document.createElement("input");
      inp.type = "file"; inp.accept = "application/json";
      inp.onchange = async () => {
        const f = inp.files?.[0]; if (!f) return;
        const text = await f.text();
        setProfileText(text);
      };
      inp.click();
    }

    // Robust loader: tries the two correct paths for your Pages setup
    async function importProfileFromAssets(){
      const candidates = [
        "/bff-suite/assets/TJF_BFF_Profile.json", // absolute (site root)
        "assets/TJF_BFF_Profile.json"             // relative to this page
      ];
      for (const url of candidates) {
        try {
          const r = await fetch(url, { cache: "no-store" });
          if (r.ok) {
            const text = await r.text();
            setProfileText(text);
            return;
          }
        } catch {}
      }
      status("Could not load assets/TJF_BFF_Profile.json");
      alert("Make sure TJF_BFF_Profile.json is in trey-suite/assets/ and deployed.");
    }

    // Simple demo save (local only, same as before)
    function save(){
      const txt = document.getElementById('note').value.trim();
      if(!txt){ alert('Type a note first.'); return; }
      const k = 'trey_notes';
      const all = JSON.parse(localStorage.getItem(k) || '[]');
      all.push({ t: Date.now(), text: txt });
      localStorage.setItem(k, JSON.stringify(all));
      document.getElementById('note').value = '';
      alert('Saved locally ✅');
    }

    // Wire buttons + boot with any existing profile
    document.getElementById('btnImport').onclick   = importProfileFromFile;
    document.getElementById('btnLoadTJF').onclick  = importProfileFromAssets;
    document.getElementById('btnProfile').onclick  = () => window.open('TJF_Avatar_Profile_Card.html','_blank');

    (function boot(){
      const text = localStorage.getItem("bff_profile_json");
      if (text) { try { applyProfile(JSON.parse(text)); } catch {} }
    })();
  </script>
</body>
</html>
